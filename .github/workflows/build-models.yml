name: Build SR Models

on:
  workflow_dispatch:
  schedule:
    # Weekly check for new models (Monday 06:00 UTC)
    - cron: '0 6 * * 1'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone ESP-SR
        run: |
          git clone --depth 1 https://github.com/espressif/esp-sr.git

      - name: Get ESP-SR commit hash
        id: esp_sr
        run: |
          cd esp-sr
          echo "hash=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "date=$(date -u +%Y%m%d)" >> "$GITHUB_OUTPUT"

      - name: Copy pack_model.py
        run: cp esp-sr/model/pack_model.py .

      - name: Fetch ESP-SR LICENSE
        run: cp esp-sr/LICENSE LICENSE.esp-sr

      - name: Build model partition images
        run: |
          mkdir -p output
          cd esp-sr/model/wakenet_model

          # Collect all wn9_* models, pick best variant per base wake word
          # Priority: real speech (no suffix) > _tts3 > _tts2 > _tts
          declare -A best_model

          for model_dir in wn9_*; do
            [ -d "$model_dir" ] || continue

            # Skip archived/versioned directories (e.g. _tts_v1)
            case "$model_dir" in
              *_v[0-9]*) echo "Skipping archived model: $model_dir"; continue ;;
            esac

            # Strip wn9_ prefix and _tts* suffix to get base name
            base="${model_dir#wn9_}"
            base="${base%_tts3}"
            base="${base%_tts2}"
            base="${base%_tts}"

            # Determine priority (higher = better)
            case "$model_dir" in
              *_tts3) prio=2 ;;
              *_tts2) prio=3 ;;
              *_tts)  prio=1 ;;
              *)      prio=4 ;;  # real speech, best
            esac

            current_prio="${best_model[$base]%%:*}"
            current_prio="${current_prio:-0}"

            if [ "$prio" -gt "$current_prio" ]; then
              best_model[$base]="${prio}:${model_dir}"
            fi
          done

          # Build only the best variant per wake word
          for base in "${!best_model[@]}"; do
            model_dir="${best_model[$base]#*:}"
            echo "Packing model: $model_dir (as $base)"

            # Create a temp directory with just this model
            tmp_dir=$(mktemp -d)
            cp -r "$model_dir" "$tmp_dir/"

            # Pack the single model into srmodels.bin
            python3 ../../../pack_model.py -m "$tmp_dir" -o srmodels.bin

            # Create tarball with clean name (no wn9_ prefix or _tts* suffix)
            mkdir -p "../../../output/${base}"
            mv "${tmp_dir}/srmodels.bin" "../../../output/${base}/"
            cp ../../../LICENSE.esp-sr "../../../output/${base}/LICENSE"
            cat > "../../../output/${base}/SOURCE.txt" <<EOF
          Wake word: ${base}
          Source model: ${model_dir}
          Repository: https://github.com/espressif/esp-sr/tree/master/model/wakenet_model/${model_dir}
          Built from esp-sr commit: ${{ steps.esp_sr.outputs.hash }}
          EOF

            cd ../../../output
            tar czf "${base}.tar.gz" "${base}"
            cd ../esp-sr/model/wakenet_model

            rm -rf "$tmp_dir"
            echo "Done: ${base} (from ${model_dir})"
          done

      - name: List built models
        run: ls -lh output/*.tar.gz

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.esp_sr.outputs.date }}-${{ steps.esp_sr.outputs.hash }}"
          name: "SR Models (${{ steps.esp_sr.outputs.date }}, esp-sr@${{ steps.esp_sr.outputs.hash }})"
          body: |
            Pre-built WakeNet v9 model partition images for Willow OTA.

            Built from [espressif/esp-sr@${{ steps.esp_sr.outputs.hash }}](https://github.com/espressif/esp-sr/commit/${{ steps.esp_sr.outputs.hash }}).

            Each tarball contains:
            - `srmodels.bin` — ready to flash via Willow srmodel OTA
            - `LICENSE` — MIT license from Espressif
            - `SOURCE.txt` — provenance information

            Models are named by wake word (e.g. `heywillow`), with the best
            available training variant selected automatically.
          files: output/*.tar.gz
          make_latest: true
